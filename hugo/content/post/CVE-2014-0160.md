---
title: "CVE-2014-0160 心脏滴血漏洞挖掘与分析"
description: "借助于libFuzzer进行Fuzzing"
date: 2022-05-20T17:57:07+08:00
tags: [ "Fuzzing", "漏洞分析" ]
Imagelink: "https://s2.loli.net/2022/05/20/atE5hjX1gbFPnUN.jpg"
---



## Fuzzing 挖掘 CVE-2014-0160

使用Google的[fuzzer-test-suite](https://github.com/google/fuzzer-test-suite)来实践，先构建包含漏洞的openssl：

```sh
git clone https://github.com/google/fuzzer-test-suite.git
mkdir CVE-2014-0160; cd CVE-2014-0160
../fuzzer-test-suite/openssl-1.0.1f/build.sh
```

This command will download the openssl sources at the affected revision and build the fuzzer for one specific API that has the bug, see [openssl-1.0.1f/target.cc](https://github.com/google/fuzzer-test-suite/blob/master/openssl-1.0.1f/target.cc)：

```c
// Copyright 2016 Google Inc. All Rights Reserved.
// Licensed under the Apache License, Version 2.0 (the "License");
#include <openssl/ssl.h>
#include <openssl/err.h>
#include <assert.h>
#include <stdint.h>
#include <stddef.h>

SSL_CTX *Init() {
  SSL_library_init();
  SSL_load_error_strings();
  ERR_load_BIO_strings();
  OpenSSL_add_all_algorithms();
  SSL_CTX *sctx;
  assert (sctx = SSL_CTX_new(TLSv1_method()));
  /* These two file were created with this command:
      openssl req -x509 -newkey rsa:512 -keyout server.key \
     -out server.pem -days 9999 -nodes -subj /CN=a/
  */
  assert(SSL_CTX_use_certificate_file(sctx, "runtime/server.pem",
                                      SSL_FILETYPE_PEM));
  assert(SSL_CTX_use_PrivateKey_file(sctx, "runtime/server.key",
                                     SSL_FILETYPE_PEM));
  return sctx;
}
extern "C" int LLVMFuzzerTestOneInput(const uint8_t *Data, size_t Size) {
  static SSL_CTX *sctx = Init();
  SSL *server = SSL_new(sctx);
  BIO *sinbio = BIO_new(BIO_s_mem());
  BIO *soutbio = BIO_new(BIO_s_mem());
  SSL_set_bio(server, sinbio, soutbio);
  SSL_set_accept_state(server);
  BIO_write(sinbio, Data, Size);
  SSL_do_handshake(server);
  SSL_free(server);
  return 0;
}
```

构建完成后运行刚刚编译好的fuzzer：

```sh
./openssl-1.0.1f-fsanitize_fuzzer
```

就能跑出：

```sh
=================================================================
==2190163==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x629000009748 at pc 0x00000051d75a bp 0x7fff7d14a450 sp 0x7fff7d149c18
READ of size 33536 at 0x629000009748 thread T0
    #0 0x51d759 in __asan_memcpy (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51d759)
    #1 0x55c283 in tls1_process_heartbeat /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/t1_lib.c:2586:3
    #2 0x5c7321 in ssl3_read_bytes /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_pkt.c:1092:4
    #3 0x5cb7f3 in ssl3_get_message /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:457:7
    #4 0x597c86 in ssl3_get_client_hello /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:941:4
    #5 0x593b21 in ssl3_accept /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:357:9
    #6 0x55052d in LLVMFuzzerTestOneInput /root/lab/fuzzing_baby/CVE-2014-0160/../fuzzer-test-suite/openssl-1.0.1f/target.cc:34:3
    #7 0x4587a1 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x4587a1)
    #8 0x457ee5 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x457ee5)
    #9 0x45a187 in fuzzer::Fuzzer::MutateAndTestOne() (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45a187)
    #10 0x45ae85 in fuzzer::Fuzzer::Loop(std::__Fuzzer::vector<fuzzer::SizedFile, fuzzer::fuzzer_allocator<fuzzer::SizedFile> >&) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45ae85)
    #11 0x44983e in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x44983e)
    #12 0x472682 in main (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x472682)
    #13 0x7f58322b0082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16
    #14 0x41e5dd in _start (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x41e5dd)

0x629000009748 is located 0 bytes to the right of 17736-byte region [0x629000005200,0x629000009748)
allocated by thread T0 here:
    #0 0x51e30d in malloc (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51e30d)
    #1 0x5fab2b in CRYPTO_malloc /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/crypto/mem.c:308:8
    #2 0x5ccf07 in freelist_extract /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:708:12
    #3 0x5ccf07 in ssl3_setup_read_buffer /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:770:10
    #4 0x5cd51c in ssl3_setup_buffers /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:827:7
    #5 0x59474f in ssl3_accept /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:292:9
    #6 0x55052d in LLVMFuzzerTestOneInput /root/lab/fuzzing_baby/CVE-2014-0160/../fuzzer-test-suite/openssl-1.0.1f/target.cc:34:3
    #7 0x4587a1 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x4587a1)
    #8 0x45a4da in fuzzer::Fuzzer::ReadAndExecuteSeedCorpora(std::__Fuzzer::vector<fuzzer::SizedFile, fuzzer::fuzzer_allocator<fuzzer::SizedFile> >&) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45a4da)
    #9 0x45ab69 in fuzzer::Fuzzer::Loop(std::__Fuzzer::vector<fuzzer::SizedFile, fuzzer::fuzzer_allocator<fuzzer::SizedFile> >&) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45ab69)
    #10 0x44983e in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x44983e)
    #11 0x472682 in main (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x472682)
    #12 0x7f58322b0082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16

SUMMARY: AddressSanitizer: heap-buffer-overflow (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51d759) in __asan_memcpy
Shadow bytes around the buggy address:
  0x0c527fff9290: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c527fff92a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c527fff92b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c527fff92c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c527fff92d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x0c527fff92e0: 00 00 00 00 00 00 00 00 00[fa]fa fa fa fa fa fa
  0x0c527fff92f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c527fff9300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c527fff9310: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c527fff9320: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c527fff9330: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==2190163==ABORTING
MS: 1 CopyPart-; base unit: 380cd810619fc15deda5a170f6bec4cfd229086b
0x18,0x3,0x29,0x0,0x1,0x1,0x0,
\x18\x03)\x00\x01\x01\x00
artifact_prefix='./'; Test unit written to ./crash-8f882413170d68fb148303a53b5208b0f2dc61cc
Base64: GAMpAAEBAA==
```



## 漏洞分析

