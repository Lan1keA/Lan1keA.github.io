<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <title>やれやれ DA✰ZE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="借助于libFuzzer进行Fuzzing" />
    <meta property="og:title" content="CVE-2014-0160 心脏滴血漏洞挖掘与分析" />
    <meta property="og:description" content="借助于libFuzzer进行Fuzzing" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://dev2ero.github.io/post/cve-2014-0160/" />
    <meta itemprop="name" content="CVE-2014-0160 心脏滴血漏洞挖掘与分析">
    <meta itemprop="description" content="借助于libFuzzer进行Fuzzing">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    
    <link rel="stylesheet" href="https://dev2ero.github.io/scss/style.min.5cc161ce25a37cfa33a6a8df8803b39268d6c4b6a5be5bb9d1f929e7f113117f.css" >
</head>
<body>
    <header>
    <div class="header header-frame">
        <div>
          
            <h1 class="header__title">CVE-2014-0160 心脏滴血漏洞挖掘与分析</h1>
          
            
                <div class="header__description">借助于libFuzzer进行Fuzzing</div>
            
        </div>
        <nav class="header-nav">
            <ul class="header-nav-list header-nav-list--menu">
                
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/about/">
                                
                                <span>About</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/board/">
                                
                                <span>Board</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/flink/">
                                
                                <span>Flink</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/utils/">
                                
                                <span>Utils</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/love/">
                                
                                <span>Love</span>
                            </a>
                        </li>
                    
                
            </ul>
            <button class="header-nav-list__nav-btn">⨈</button>
        </nav>
        <button class="mb-header__menu-btn">
            <span class="mb-header__menu-btn-line"></span>
            <span class="mb-header__menu-btn-line"></span>
            <span class="mb-header__menu-btn-line"></span>
        </button>
    </div>
    <nav id="mobile-header-nav" class="mb-header-nav">
  
  
  <button class="mb-header-nav__close-btn flex-center">
    <svg
            class="mb-header-nav__svg-icon"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="32"
            height="32"
            >
            <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                />
            <path d="M0 0h24v24H0z" fill="none" />
        </svg>
    </button>
    
    <div class="mb-header-nav__wrapper">
        <div class="mb-header-nav__container">
            <svg
                width="240"
                height="72"
                viewBox="0 0 240 72"
                class="mb-header-nav__title"
                >
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">
                Tags
                </text>
            </svg>
            <ul class="mb-header-nav-list">
                
                    
                        
                          <li class="mb-header-nav-list__item ">
                        <a class="mb-header-nav-list__link" href="https://dev2ero.github.io/tags/fuzzing/"
                                                            >Fuzzing</a
                                                        >
                    </li>
                        
                    
                        
                    
                
            </ul>
        </div>
        <div class="mb-header-nav__container">
            <svg
                width="240"
                height="72"
                viewBox="0 0 240 72"
                class="mb-header-nav__title"
                >
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">
                Menu
                </text>
            </svg>
            <ul class="mb-header-nav-list">
                
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/about/">
                                About
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/board/">
                                Board
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/flink/">
                                Flink
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/utils/">
                                Utils
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/love/">
                                Love
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </div>
</nav>

</header>



    <div id="content">
<article class="post">
  
    <div class="post-content"><blockquote>
<p>漏洞编号：CVE-2014-0160
漏洞类型：内存越界访问
漏洞危害：信息泄露
影响范围：OpenSSL1.0.1、OpenSSL 1.0.1a~ OpenSSL 1.0.1f、OpenSSL 1.0.2-beta
漏洞描述：OpenSSL 在实现 TLS（传输层安全协议）和 DTLS（数据报安全传输协议）的心跳包处理逻辑时存在问题。OpenSSL 的 Heartbleed 模块在处理心跳包时没有检查心跳包中的长度字段是否与后续的数据字段一致，攻击者利用该漏洞构造异常数据包，可获取服务器内存中多达 64KB 的数据。这些数据可能会包含证书私钥、用户账号、密码、邮件内容等敏感信息。</p>
</blockquote>
<h2 id="背景知识">背景知识</h2>
<h3 id="简介">简介</h3>
<p><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">传输层安全性协议SSL</a></p>
<p><strong>SSL</strong> 全称 Secure Sockets Layer（安全套接字层协议），要求建立在可靠的传输层协议（<strong>TCP</strong>）之上，主要提供机密性、认证性及数据完整性服务。SSL 最初（SSL 1.0、SSL2.0、SSL 3.0 版本）由网景公司设计和维护，从 3.1 版本开始，SSL 协议由因特网工程任务小组（IETF）正式接管，并更名为 <strong>TLS</strong>（传输层安全协议，Transport Layer Security），发展至今已有 TLS 1.0、TLS1.1、TLS1.2 三个版本。</p>
<p>SSL/TLS 协议能够提供的安全服务主要包括：</p>
<ul>
<li>认证性——使用数字证书认证服务器和客户端身份，防止身份伪造；</li>
<li>机密性——使用加密算法防止第三方窃听；</li>
<li>完整性——使用消息认证码（MAC）保障数据完整性，防止消息被篡改；</li>
<li>重放保护——通过使用隐式序列号防止重放攻击；</li>
</ul>
<h3 id="ssl握手过程">SSL握手过程</h3>
<p>客户端获取服务器的数字证书后，协商后续数据传输所使用的对称加密密钥。</p>
<p><img src="https://s2.loli.net/2022/05/23/v2tSmBZsi1PWHTO.png" alt="img"></p>
<h3 id="ssl-heartbeat">SSL Heartbeat</h3>
<blockquote>
<p>Heartbleed was introduced by the Heartbeat Extension in the OpenSSL version 1.0.11 . This extension enables a low-cost, keepalive mechanism for peers to know that they’re still connected and all is well at the TLS layer. Standard implementations of TLS do not require the extension as they can rely on TCP for equivalent session management. Version 1.0.1 of OpenSSL added support for the Heartbeat functionality and enabled it by default.</p>
</blockquote>
<p>文档：<a href="https://datatracker.ietf.org/doc/html/rfc6520">Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS) Heartbeat Extension</a></p>
<p>SSL 协议完成握手过程后，客户端和服务器间便建立安全可靠的通信。SSL 安全协议工作在传输层的 TCP 协议之上，所以服务器和客户端需要保持持续连接的状态。由于服务器的资源有限，当连接的客户端数量较大时，服务器要维持这些连接将会消耗很多资源，因此需要及时断开完成通信的客户端以减少服务器的负载压力。服务器通过 SSL 的心跳机制可判断客户端是否已完成通信。</p>
<p>SSL 协议中的心跳机制工作于 SSL 记录协议之上，心跳机制中包含两种类型的消息：心跳请求消息（HeartbeatRequest Message）和心跳响应消息（HeartbeatResponse Message），这两种消息具有相同的包结构。当服务器和客户端完成 SSL 协议的握手阶段后，如果客户端一段时间没有与服务器进行数据交互，客户端需要周期性地向服务器发送心跳请求消息。服务器接收到客户端的心跳请求消息，则认为客户端还没有完成通信，继续维持客户端和服务器的连接，并向客户端发送心跳响应消息。</p>
<p>通信双方在建立 SSL 连接时可协商是否支持心跳机制。在 SSL 第一次握手过程中通过 Client Hello 消息和 Server Hello 消息的 Heartbeat Hello 扩展告知对方是否支持心跳机制。Heartbeat Hello 扩展的格式如下。当支持心跳机制时设置 HeartbeatMode 为 peer_allowed_to_send，可接收心跳请求消息并能返回响应包；当不支持心跳机制时设置 HeartbeatMode 为 peer_not_allowed_to_send，若对端发送心跳请求消息，将会丢弃该消息并返回 unexpected_message 警告消息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">enum</span> {
</span></span><span style="display:flex;"><span>    peer_allowed_to_send(<span style="color:#099">1</span>),
</span></span><span style="display:flex;"><span>    peer_not_allowed_to_send(<span style="color:#099">2</span>),
</span></span><span style="display:flex;"><span>} HeartbeatMode;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>    HeartbeatMode mode;
</span></span><span style="display:flex;"><span>} HeartbeatExtension;
</span></span></code></pre></div><p>心跳包的结构如下图所示，前半部分为 SSL 记录头，Content Type 为消息类型（0x18 表示心跳包消息），TLS Version 为 SSL 版本信息，Record length 为记录长度；后半部分即为心跳消息。</p>
<p><img src="https://s2.loli.net/2022/05/23/rfcnZhoetL6jK9C.png" alt="img"></p>
<p>其中，SSL 记录长度（Record length）为心跳消息的总长度。心跳包消息由数据包类型（type）、载荷长度（payload length）、载荷内容（payload）和填充字节（padding）组成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">struct</span> {
</span></span><span style="display:flex;"><span>      HeartbeatMessageType type;    <span style="color:#998;font-style:italic">// 1 bytes，包括request 和 response两种类型
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      uint16 payload_length;    <span style="color:#998;font-style:italic">// 2 bytes，载荷长度
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      opaque payload[HeartbeatMessage.payload_length];    <span style="color:#998;font-style:italic">// payload_length bytes，载荷内容
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>      opaque padding[padding_length];    <span style="color:#998;font-style:italic">// 填充字节，至少为16 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>} HeartbeatMessage;
</span></span></code></pre></div><p>下图为心跳请求包的数据包实例，其载荷长度为 5 bytes：</p>
<p><img src="https://s2.loli.net/2022/05/23/i6WzNbtolc4VrZn.png" alt="1586019909_91460635.jpg"></p>
<h3 id="openssl">OpenSSL</h3>
<p><a href="https://www.openssl.org/">https://www.openssl.org/</a></p>
<p>查阅文档：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>man <span style="color:#099">7</span> crypto
</span></span></code></pre></div><blockquote>
<p>The OpenSSL crypto library (<code>libcrypto</code>) implements a wide range of cryptographic algorithms used in various Internet standards. The services provided by this library are used by the OpenSSL implementations of TLS and CMS, and they have also been used to implement many other third party products and protocols.</p>
<p>The functionality includes symmetric encryption, public key cryptography, key agreement, certificate handling, cryptographic hash functions, cryptographic pseudo-random number generators, message authentication codes (MACs), key derivation functions (KDFs), and various utilities.</p>
</blockquote>
<h2 id="fuzzing-挖掘-cve-2014-0160">Fuzzing 挖掘 CVE-2014-0160</h2>
<p>使用Google的<a href="https://github.com/google/fuzzer-test-suite">fuzzer-test-suite</a>来实践，先构建包含漏洞的openssl：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/google/fuzzer-test-suite.git
</span></span><span style="display:flex;"><span>mkdir CVE-2014-0160; <span style="color:#0086b3">cd</span> CVE-2014-0160
</span></span><span style="display:flex;"><span>../fuzzer-test-suite/openssl-1.0.1f/build.sh
</span></span></code></pre></div><p>This command will download the openssl sources at the affected revision and build the fuzzer for one specific API that has the bug, see <a href="https://github.com/google/fuzzer-test-suite/blob/master/openssl-1.0.1f/target.cc">openssl-1.0.1f/target.cc</a>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Copyright 2016 Google Inc. All Rights Reserved.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;openssl/ssl.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;openssl/err.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;assert.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;stdint.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;stddef.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#999;font-weight:bold;font-style:italic"></span>
</span></span><span style="display:flex;"><span>SSL_CTX <span style="color:#000;font-weight:bold">*</span><span style="color:#900;font-weight:bold">Init</span>() {
</span></span><span style="display:flex;"><span>  SSL_library_init();
</span></span><span style="display:flex;"><span>  SSL_load_error_strings();
</span></span><span style="display:flex;"><span>  ERR_load_BIO_strings();
</span></span><span style="display:flex;"><span>  OpenSSL_add_all_algorithms();
</span></span><span style="display:flex;"><span>  SSL_CTX <span style="color:#000;font-weight:bold">*</span>sctx;
</span></span><span style="display:flex;"><span>  assert (sctx <span style="color:#000;font-weight:bold">=</span> SSL_CTX_new(TLSv1_method()));
</span></span><span style="display:flex;"><span>  <span style="color:#998;font-style:italic">/* These two file were created with this command:
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">      openssl req -x509 -newkey rsa:512 -keyout server.key \
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">     -out server.pem -days 9999 -nodes -subj /CN=a/
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span>  assert(SSL_CTX_use_certificate_file(sctx, <span style="color:#d14">&#34;runtime/server.pem&#34;</span>,
</span></span><span style="display:flex;"><span>                                      SSL_FILETYPE_PEM));
</span></span><span style="display:flex;"><span>  assert(SSL_CTX_use_PrivateKey_file(sctx, <span style="color:#d14">&#34;runtime/server.key&#34;</span>,
</span></span><span style="display:flex;"><span>                                     SSL_FILETYPE_PEM));
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> sctx;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">extern</span> <span style="color:#d14">&#34;C&#34;</span> <span style="color:#458;font-weight:bold">int</span> LLVMFuzzerTestOneInput(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">uint8_t</span> <span style="color:#000;font-weight:bold">*</span>Data, size_t Size) {
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">static</span> SSL_CTX <span style="color:#000;font-weight:bold">*</span>sctx <span style="color:#000;font-weight:bold">=</span> Init();
</span></span><span style="display:flex;"><span>  SSL <span style="color:#000;font-weight:bold">*</span>server <span style="color:#000;font-weight:bold">=</span> SSL_new(sctx);
</span></span><span style="display:flex;"><span>  BIO <span style="color:#000;font-weight:bold">*</span>sinbio <span style="color:#000;font-weight:bold">=</span> BIO_new(BIO_s_mem());
</span></span><span style="display:flex;"><span>  BIO <span style="color:#000;font-weight:bold">*</span>soutbio <span style="color:#000;font-weight:bold">=</span> BIO_new(BIO_s_mem());
</span></span><span style="display:flex;"><span>  SSL_set_bio(server, sinbio, soutbio);
</span></span><span style="display:flex;"><span>  SSL_set_accept_state(server);
</span></span><span style="display:flex;"><span>  BIO_write(sinbio, Data, Size);
</span></span><span style="display:flex;"><span>  SSL_do_handshake(server);
</span></span><span style="display:flex;"><span>  SSL_free(server);
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>构建完成后运行刚刚编译好的fuzzer：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./openssl-1.0.1f-fsanitize_fuzzer
</span></span></code></pre></div><p>就能跑出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">=================================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">==</span><span style="color:#008080">2190163</span><span style="color:#000;font-weight:bold">==</span>ERROR: AddressSanitizer: heap-buffer-overflow on address 0x629000009748 at pc 0x00000051d75a bp 0x7fff7d14a450 sp 0x7fff7d149c18
</span></span><span style="display:flex;"><span>READ of size <span style="color:#099">33536</span> at 0x629000009748 thread T0
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#0 0x51d759 in __asan_memcpy (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51d759)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#1 0x55c283 in tls1_process_heartbeat /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/t1_lib.c:2586:3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#2 0x5c7321 in ssl3_read_bytes /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_pkt.c:1092:4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#3 0x5cb7f3 in ssl3_get_message /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:457:7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#4 0x597c86 in ssl3_get_client_hello /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:941:4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#5 0x593b21 in ssl3_accept /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:357:9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#6 0x55052d in LLVMFuzzerTestOneInput /root/lab/fuzzing_baby/CVE-2014-0160/../fuzzer-test-suite/openssl-1.0.1f/target.cc:34:3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#7 0x4587a1 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x4587a1)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#8 0x457ee5 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x457ee5)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#9 0x45a187 in fuzzer::Fuzzer::MutateAndTestOne() (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45a187)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#10 0x45ae85 in fuzzer::Fuzzer::Loop(std::__Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45ae85)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#11 0x44983e in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x44983e)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#12 0x472682 in main (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x472682)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#13 0x7f58322b0082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#14 0x41e5dd in _start (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x41e5dd)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>0x629000009748 is located <span style="color:#099">0</span> bytes to the right of 17736-byte region <span style="color:#000;font-weight:bold">[</span>0x629000005200,0x629000009748<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>allocated by thread T0 here:
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#0 0x51e30d in malloc (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51e30d)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#1 0x5fab2b in CRYPTO_malloc /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/crypto/mem.c:308:8</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#2 0x5ccf07 in freelist_extract /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:708:12</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#3 0x5ccf07 in ssl3_setup_read_buffer /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:770:10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#4 0x5cd51c in ssl3_setup_buffers /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_both.c:827:7</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#5 0x59474f in ssl3_accept /root/lab/fuzzing_baby/CVE-2014-0160/BUILD/ssl/s3_srvr.c:292:9</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#6 0x55052d in LLVMFuzzerTestOneInput /root/lab/fuzzing_baby/CVE-2014-0160/../fuzzer-test-suite/openssl-1.0.1f/target.cc:34:3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#7 0x4587a1 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x4587a1)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#8 0x45a4da in fuzzer::Fuzzer::ReadAndExecuteSeedCorpora(std::__Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45a4da)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#9 0x45ab69 in fuzzer::Fuzzer::Loop(std::__Fuzzer::vector&lt;fuzzer::SizedFile, fuzzer::fuzzer_allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x45ab69)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#10 0x44983e in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x44983e)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#11 0x472682 in main (/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x472682)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">#12 0x7f58322b0082 in __libc_start_main /build/glibc-SzIz7B/glibc-2.31/csu/../csu/libc-start.c:308:16</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SUMMARY: AddressSanitizer: heap-buffer-overflow <span style="color:#000;font-weight:bold">(</span>/f/lab/fuzzing_baby/CVE-2014-0160/openssl-1.0.1f-fsanitize_fuzzer+0x51d759<span style="color:#000;font-weight:bold">)</span> in __asan_memcpy
</span></span><span style="display:flex;"><span>Shadow bytes around the buggy address:
</span></span><span style="display:flex;"><span>  0x0c527fff9290: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span>
</span></span><span style="display:flex;"><span>  0x0c527fff92a0: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span>
</span></span><span style="display:flex;"><span>  0x0c527fff92b0: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span>
</span></span><span style="display:flex;"><span>  0x0c527fff92c0: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span>
</span></span><span style="display:flex;"><span>  0x0c527fff92d0: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#008080">00</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">=</span>&gt;0x0c527fff92e0: <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> <span style="color:#099">00</span> 00<span style="color:#000;font-weight:bold">[</span>fa<span style="color:#000;font-weight:bold">]</span>fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>  0x0c527fff92f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>  0x0c527fff9300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>  0x0c527fff9310: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>  0x0c527fff9320: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>  0x0c527fff9330: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
</span></span><span style="display:flex;"><span>Shadow byte legend <span style="color:#000;font-weight:bold">(</span>one shadow byte represents <span style="color:#099">8</span> application bytes<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>  Addressable:           <span style="color:#099">00</span>
</span></span><span style="display:flex;"><span>  Partially addressable: <span style="color:#099">01</span> <span style="color:#099">02</span> <span style="color:#099">03</span> <span style="color:#099">04</span> <span style="color:#099">05</span> <span style="color:#099">06</span> <span style="color:#099">07</span>
</span></span><span style="display:flex;"><span>  Heap left redzone:       fa
</span></span><span style="display:flex;"><span>  Freed heap region:       fd
</span></span><span style="display:flex;"><span>  Stack left redzone:      f1
</span></span><span style="display:flex;"><span>  Stack mid redzone:       f2
</span></span><span style="display:flex;"><span>  Stack right redzone:     f3
</span></span><span style="display:flex;"><span>  Stack after <span style="color:#000;font-weight:bold">return</span>:      f5
</span></span><span style="display:flex;"><span>  Stack use after scope:   f8
</span></span><span style="display:flex;"><span>  Global redzone:          f9
</span></span><span style="display:flex;"><span>  Global init order:       f6
</span></span><span style="display:flex;"><span>  Poisoned by user:        f7
</span></span><span style="display:flex;"><span>  Container overflow:      <span style="color:#0086b3">fc</span>
</span></span><span style="display:flex;"><span>  Array cookie:            ac
</span></span><span style="display:flex;"><span>  Intra object redzone:    bb
</span></span><span style="display:flex;"><span>  ASan internal:           fe
</span></span><span style="display:flex;"><span>  Left alloca redzone:     ca
</span></span><span style="display:flex;"><span>  Right alloca redzone:    cb
</span></span><span style="display:flex;"><span>  Shadow gap:              <span style="color:#008080">cc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">==</span><span style="color:#008080">2190163</span><span style="color:#000;font-weight:bold">==</span>ABORTING
</span></span><span style="display:flex;"><span>MS: <span style="color:#099">1</span> CopyPart-; base unit: 380cd810619fc15deda5a170f6bec4cfd229086b
</span></span><span style="display:flex;"><span>0x18,0x3,0x29,0x0,0x1,0x1,0x0,
</span></span><span style="display:flex;"><span><span style="color:#d14">\x</span>18<span style="color:#d14">\x</span>03<span style="color:#000;font-weight:bold">)</span><span style="color:#d14">\x</span>00<span style="color:#d14">\x</span>01<span style="color:#d14">\x</span>01<span style="color:#d14">\x</span><span style="color:#099">00</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">artifact_prefix</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;./&#39;</span>; Test unit written to ./crash-8f882413170d68fb148303a53b5208b0f2dc61cc
</span></span><span style="display:flex;"><span>Base64: <span style="color:#008080">GAMpAAEBAA</span><span style="color:#000;font-weight:bold">==</span>
</span></span></code></pre></div><h2 id="漏洞分析">漏洞分析</h2>
<p>修复的patch：https://bugzilla.redhat.com/attachment.cgi?id=883475&amp;action=diff</p>
<p>获取含漏洞的源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone git://git.openssl.org/openssl.git
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> openssl
</span></span><span style="display:flex;"><span>git checkout OpenSSL_1_0_1f
</span></span></code></pre></div><p>OpenSSL 是 SSL 协议实现的开源软件包，存在漏洞的两个文件为 ssl/d1_both.c 和 ssl/t1_lib.c，这两个文件中的 dtls1_process_heartbeat 函数和 tls1_process_heartbeat 函数分别为 DTLS（数据报安全传输协议）和 TLS（传输层安全协议）处理心跳请求包的函数。两函数的实现完全相同，此处选取 tls1_process_heartbeat 进行分析。</p>
<p>先来预习一下漏洞成因：</p>
<p><img src="https://s2.loli.net/2022/05/23/7bzQV5f1GZLcCgl.jpg" alt="Snipaste_2022-05-23_18-12-44.jpg"></p>
<p><a href="http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/">http://0x4c43.cn/2018/0701/heartbleed-vulnerability-analysis/</a></p>
</div>
  
</article>
<button class="floating-button">
    <a class="floating-button__link" href="https://dev2ero.github.io/">
        <span style="font-size: large;">⪡</span>
    </a>
</button>


    </div>
    
    <footer class="post-footer">
    <div class="footer">
        
            <div>© 2022, Zikey Vi</div>
        
        <div class="footer__socials">


<a
  href="mailto:dev2ero@foxmail.com"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Gmail</title><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://github.com/dev2ero"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://twitter.com/dev2ero"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://space.bilibili.com/210892014"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Bilibili</title><path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://www.zhihu.com/people/izay01"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Zhihu</title><path d="M5.721 0C2.251 0 0 2.25 0 5.719V18.28C0 21.751 2.252 24 5.721 24h12.56C21.751 24 24 21.75 24 18.281V5.72C24 2.249 21.75 0 18.281 0zm1.964 4.078c-.271.73-.5 1.434-.68 2.11h4.587c.545-.006.445 1.168.445 1.171H9.384a58.104 58.104 0 01-.112 3.797h2.712c.388.023.393 1.251.393 1.266H9.183a9.223 9.223 0 01-.408 2.102l.757-.604c.452.456 1.512 1.712 1.906 2.177.473.681.063 2.081.063 2.081l-2.794-3.382c-.653 2.518-1.845 3.607-1.845 3.607-.523.468-1.58.82-2.64.516 2.218-1.73 3.44-3.917 3.667-6.497H4.491c0-.015.197-1.243.806-1.266h2.71c.024-.32.086-3.254.086-3.797H6.598c-.136.406-.158.447-.268.753-.594 1.095-1.603 1.122-1.907 1.155.906-1.821 1.416-3.6 1.591-4.064.425-1.124 1.671-1.125 1.671-1.125zM13.078 6h6.377v11.33h-2.573l-2.184 1.373-.401-1.373h-1.219zm1.313 1.219v8.86h.623l.263.937 1.455-.938h1.456v-8.86z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="/main/love/"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Love</title><path d="M12 6.306L7.796 2.102 0 9.898l12 12 12-12-7.796-7.796zm0 12L3.592 9.898l4.204-4.204L12 9.898l4.184-4.184 4.204 4.204"/></svg>
</a>
</div>
    </div>
</footer>


    
    
      
<script src="https://dev2ero.github.io/js/script.js"></script>

    
  </body>
</html>
