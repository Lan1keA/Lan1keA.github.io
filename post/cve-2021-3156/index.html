<!DOCTYPE html>
<html lang="zh"><head>
    <meta charset="UTF-8">
    <title>やれやれ DA✰ZE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="阅内核洞前先来阅阅用户态的洞吧" />
    <meta property="og:title" content="CVE-2021-3156 sudo 提权漏洞分析" />
    <meta property="og:description" content="阅内核洞前先来阅阅用户态的洞吧" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://cerr.cc/post/cve-2021-3156/" />
    <meta itemprop="name" content="CVE-2021-3156 sudo 提权漏洞分析">
    <meta itemprop="description" content="阅内核洞前先来阅阅用户态的洞吧">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    
    <link rel="stylesheet" href="https://cerr.cc/scss/style.min.8cf7a5758f9d406f171a1184f6b6ec0a6175c7d809e6dd601dd4878d8acf96b1.css" >
</head>
<body>
    <header>
    <div class="header header-frame">
        <div>
          
            <h1 class="header__title">CVE-2021-3156 sudo 提权漏洞分析</h1>
          
            
                <div class="header__description">阅内核洞前先来阅阅用户态的洞吧</div>
            
        </div>
        <nav class="header-nav">
            <ul class="header-nav-list header-nav-list--menu">
                
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/about/">
                                
                                <span>About</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/board/">
                                
                                <span>Board</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/flink/">
                                
                                <span>Flink</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/utils/">
                                
                                <span>Utils</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/love/">
                                
                                <span>Love</span>
                            </a>
                        </li>
                    
                
                    
                        <li class="header-nav-list__item">
                            <a class="header-nav-list__link" href="/main/ilus/">
                                
                                <span>Ilus</span>
                            </a>
                        </li>
                    
                
            </ul>
            <button class="header-nav-list__nav-btn">~#</button>
        </nav>
        <button class="mb-header__menu-btn">
            <span class="mb-header__menu-btn-line"></span>
            <span class="mb-header__menu-btn-line"></span>
            <span class="mb-header__menu-btn-line"></span>
        </button>
    </div>
    <nav id="mobile-header-nav" class="mb-header-nav">
  
  
  <button class="mb-header-nav__close-btn flex-center">
    <svg
            class="mb-header-nav__svg-icon"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            width="32"
            height="32"
            >
            <path
                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                />
            <path d="M0 0h24v24H0z" fill="none" />
        </svg>
    </button>
    
    <div class="mb-header-nav__wrapper">
        <div class="mb-header-nav__container">
            <svg
                width="240"
                height="72"
                viewBox="0 0 240 72"
                class="mb-header-nav__title"
                >
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">
                Tags
                </text>
            </svg>
            <ul class="mb-header-nav-list">
                
                    
                        
                          <li class="mb-header-nav-list__item ">
                        <a class="mb-header-nav-list__link" href="https://cerr.cc/tags/vulnerability/"
                                                            >Vulnerability</a
                                                        >
                    </li>
                        
                    
                        
                          <li class="mb-header-nav-list__item ">
                        <a class="mb-header-nav-list__link" href="https://cerr.cc/tags/linux/"
                                                            >Linux</a
                                                        >
                    </li>
                        
                    
                
            </ul>
        </div>
        <div class="mb-header-nav__container">
            <svg
                width="240"
                height="72"
                viewBox="0 0 240 72"
                class="mb-header-nav__title"
                >
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle">
                Menu
                </text>
            </svg>
            <ul class="mb-header-nav-list">
                
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/about/">
                                About
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/board/">
                                Board
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/flink/">
                                Flink
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/utils/">
                                Utils
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/love/">
                                Love
                            </a>
                        </li>
                    
                
                    
                      <li class="mb-header-nav-list__item ">
                            <a class="mb-header-nav-list__link" href="/main/ilus/">
                                Ilus
                            </a>
                        </li>
                    
                
            </ul>
        </div>
    </div>
</nav>

</header>



    <div id="content">
<article class="post">
  
    <div class="post-content"><blockquote>
<p>CVE-2021-3156是sudo中存在一个堆溢出漏洞。影响从1.8.2~1.8.31p2下的所有旧版本sudo，以及1.9.0~1.9.5p1的所有稳定版sudo。可以使得任何没有特权的用户均可使用默认的sudo配置获取root权限</p>
</blockquote>
<h1 id="环境准备">环境准备</h1>
<p>使用apt获取软件源提供的sudo源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt <span style="color:#0086b3">source</span> sudo
</span></span></code></pre></div><p>却被告知：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tex" data-lang="tex"><span style="display:flex;"><span>NOTICE: &#39;sudo&#39; packaging is maintained in the &#39;Git&#39; version control system at:
</span></span><span style="display:flex;"><span>https://salsa.debian.org/sudo-team/sudo.git
</span></span><span style="display:flex;"><span>Please use:
</span></span><span style="display:flex;"><span>git clone https://salsa.debian.org/sudo-team/sudo.git
</span></span><span style="display:flex;"><span>to retrieve the latest (possibly unreleased) updates to the package.
</span></span></code></pre></div><p>于是听话，从git仓库获取源码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://salsa.debian.org/sudo-team/sudo.git
</span></span></code></pre></div><p>接下来进行构建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># clone configure make</span>
</span></span><span style="display:flex;"><span>git reset --hard 36955b3ef399efeea25824d32e6cfbaa444e9f07 <span style="color:#998;font-style:italic"># v1.9.5p1</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">CFLAGS</span><span style="color:#000;font-weight:bold">+=</span>-g ./configure --sysconfdir<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span><span style="color:#0086b3">pwd</span><span style="color:#d14">`</span>/examples --with-plugindir<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">`</span><span style="color:#0086b3">pwd</span><span style="color:#d14">`</span>/plugins/sudoers/.libs
</span></span><span style="display:flex;"><span>make -j<span style="color:#d14">`</span>nproc<span style="color:#d14">`</span>
</span></span></code></pre></div><p>构建完成后在root用户下可以执行测试：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>LD_LIBRARY_PATH<span style="color:#000;font-weight:bold">=</span>.<span style="color:#000;font-weight:bold">/</span>lib<span style="color:#000;font-weight:bold">/</span>util<span style="color:#000;font-weight:bold">/</span>.libs<span style="color:#000;font-weight:bold">/</span> src<span style="color:#000;font-weight:bold">/</span>.libs<span style="color:#000;font-weight:bold">/</span>sudo
</span></span></code></pre></div><p>验证编译目标的确存在漏洞，前需事先创建名为 sudoedit 的 sudo 的软链接以绕过后续检查：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#0086b3">cd</span> src/.libs
</span></span><span style="display:flex;"><span>ln -s sudo sudoedit
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> ../../
</span></span></code></pre></div><p>执行验证：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>➜  sudo git:<span style="color:#000;font-weight:bold">(</span>master<span style="color:#000;font-weight:bold">)</span> ✗ <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span><span style="display:flex;"><span>malloc<span style="color:#000;font-weight:bold">()</span>: corrupted top size
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>    <span style="color:#099">1357050</span> abort <span style="color:#000;font-weight:bold">(</span>core dumped<span style="color:#000;font-weight:bold">)</span>  <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span></code></pre></div><p>说明漏洞的确存在。</p>
<h1 id="漏洞成因">漏洞成因</h1>
<p>sudo.c 中的 main 函数，会调用 parse_args 函数来处理sudo的命令行参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/* Parse command line arguments. */</span>
</span></span><span style="display:flex;"><span>sudo_mode <span style="color:#000;font-weight:bold">=</span> parse_args(argc, argv, <span style="color:#000;font-weight:bold">&amp;</span>submit_optind, <span style="color:#000;font-weight:bold">&amp;</span>nargc, <span style="color:#000;font-weight:bold">&amp;</span>nargv, <span style="color:#000;font-weight:bold">&amp;</span>settings, <span style="color:#000;font-weight:bold">&amp;</span>env_add);
</span></span></code></pre></div><p>parse_args 函数于 parse_args.c 中实现。</p>
<p>当向 sudo 传入 -s 或 -i 参数时，sudo 执行如下行为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>-s, --shell                   run shell as the target user; a <span style="color:#0086b3">command</span> may also be specified
</span></span><span style="display:flex;"><span>-i, --login                   run login shell as the target user; a <span style="color:#0086b3">command</span> may also be specified
</span></span></code></pre></div><p>-s 或 -i 后可以接实际想要在shell中执行的命令。使用举例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo -s <span style="color:#0086b3">echo</span> <span style="color:#d14">\$</span>UID
</span></span><span style="display:flex;"><span><span style="color:#099">0</span>
</span></span></code></pre></div><p>在sudo处理参数的逻辑中，-s 会设定 flags 中的 MODE_SHELL 位，-i 会设定 flags 中的 MODE_LOGIN_SHELL 位：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">switch</span> (ch)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#39;i&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		sudo_settings[ARG_LOGIN_SHELL].value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;true&#34;</span>;
</span></span><span style="display:flex;"><span>		SET(flags, MODE_LOGIN_SHELL);
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#39;s&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		sudo_settings[ARG_USER_SHELL].value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;true&#34;</span>;
</span></span><span style="display:flex;"><span>		SET(flags, MODE_SHELL);
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><p>且后续 MODE_LOGIN_SHELL 也会设置 MODE_SHELL：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> (ISSET(flags, MODE_LOGIN_SHELL))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    SET(flags, MODE_SHELL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>加上 mode 变量中已有的 MODE_RUN 标志位，会在其后的执行流中进入如下 if 块中，用于处理sudo在特定参数下需要处理的命令行参数中的转义符<code>\</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * Command line argument parsing.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * Sets nargc and nargv which corresponds to the argc/argv we&#39;ll use
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * for the command to be run (if we are running one).
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">parse_args</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">**</span>argv, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>old_optind, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>nargc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>nargv,
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">struct</span> sudo_settings <span style="color:#000;font-weight:bold">**</span>settingsp, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>env_addp) 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ……
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// （前面是参数解析与MODE判断的一堆代码
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    * For shell mode we need to rewrite argv （只关注这块if里的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (ISSET(mode, MODE_RUN) <span style="color:#000;font-weight:bold">&amp;&amp;</span> ISSET(flags, MODE_SHELL)) {
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">**</span>av, <span style="color:#000;font-weight:bold">*</span>cmnd <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#458;font-weight:bold">int</span> ac <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (argc <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">/* shell -c &#34;command&#34; */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>src, <span style="color:#000;font-weight:bold">*</span>dst;
</span></span><span style="display:flex;"><span>            size_t cmnd_size <span style="color:#000;font-weight:bold">=</span> (size_t) (argv[argc <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">-</span> argv[<span style="color:#099">0</span>]) <span style="color:#000;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>            strlen(argv[argc <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>]) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            cmnd <span style="color:#000;font-weight:bold">=</span> dst <span style="color:#000;font-weight:bold">=</span> reallocarray(<span style="color:#0086b3">NULL</span>, cmnd_size, <span style="color:#099">2</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (cmnd <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>)
</span></span><span style="display:flex;"><span>            sudo_fatalx(U_(<span style="color:#d14">&#34;%s: %s&#34;</span>), __func__, U_(<span style="color:#d14">&#34;unable to allocate memory&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>gc_add(GC_PTR, cmnd))
</span></span><span style="display:flex;"><span>            exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          	<span style="color:#998;font-style:italic">// 从原 argv 中拷贝字符串，构建 command
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">for</span> (av <span style="color:#000;font-weight:bold">=</span> argv; <span style="color:#000;font-weight:bold">*</span>av <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">NULL</span>; av<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">for</span> (src <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>av; <span style="color:#000;font-weight:bold">*</span>src <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#39;\0&#39;</span>; src<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">/* quote potential meta characters */</span>
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">// 将数字、字母、_、-、$ 之外的所有字符前加上字符 \，用于转义
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>isalnum((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span>)<span style="color:#000;font-weight:bold">*</span>src) <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">*</span>src <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#39;_&#39;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">*</span>src <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#39;-&#39;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">*</span>src <span style="color:#000;font-weight:bold">!=</span> <span style="color:#d14">&#39;$&#39;</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">*</span>dst<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;\\&#39;</span>; <span style="color:#998;font-style:italic">// C源代码中用 &#39;\\&#39; 表示字符 \
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                *dst++ = *src;
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">*</span>dst<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39; &#39;</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (cmnd <span style="color:#000;font-weight:bold">!=</span> dst)
</span></span><span style="display:flex;"><span>            dst<span style="color:#000;font-weight:bold">--</span>;  <span style="color:#998;font-style:italic">/* replace last space with a NUL */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">*</span>dst <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            ac <span style="color:#000;font-weight:bold">+=</span> <span style="color:#099">2</span>; <span style="color:#998;font-style:italic">/* -c cmnd */</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        av <span style="color:#000;font-weight:bold">=</span> reallocarray(<span style="color:#0086b3">NULL</span>, ac <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>, <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (av <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>)
</span></span><span style="display:flex;"><span>            sudo_fatalx(U_(<span style="color:#d14">&#34;%s: %s&#34;</span>), __func__, U_(<span style="color:#d14">&#34;unable to allocate memory&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (<span style="color:#000;font-weight:bold">!</span>gc_add(GC_PTR, av))
</span></span><span style="display:flex;"><span>            exit(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        av[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>)user_details.shell; <span style="color:#998;font-style:italic">/* plugin may override shell */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (cmnd <span style="color:#000;font-weight:bold">!=</span> <span style="color:#0086b3">NULL</span>) {
</span></span><span style="display:flex;"><span>            av[<span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;-c&#34;</span>;
</span></span><span style="display:flex;"><span>            av[<span style="color:#099">2</span>] <span style="color:#000;font-weight:bold">=</span> cmnd;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        av[ac] <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">NULL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        argv <span style="color:#000;font-weight:bold">=</span> av;
</span></span><span style="display:flex;"><span>        argc <span style="color:#000;font-weight:bold">=</span> ac;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>parse_args函数是故事的开始。虽然做好了出发漏洞的准备，但到目前为止尚且无事发生。我们需要接着向下探索。故开启调试以动态跟踪，下断点于上述 if 块的起始位置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>gdb src/.libs/sudoedit
</span></span><span style="display:flex;"><span>pwndbg&gt; <span style="color:#0086b3">set</span> args -s /
</span></span><span style="display:flex;"><span>pwndbg&gt; <span style="color:#0086b3">set</span> environment <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/
</span></span><span style="display:flex;"><span>pwndbg&gt; b parse_args.c:604
</span></span><span style="display:flex;"><span>pwndbg&gt; r
</span></span></code></pre></div><p>一路向下跟踪，尽快来到本次事件的漏洞中心—— set_cmnd 函数看看。backtrace如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pwndbg&gt; bt
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#0  set_cmnd () at ./sudoers.c:922</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1  sudoers_policy_main (argc=argc@entry=3, argv=argv@entry=0x555555584590, pwflag=pwflag@entry=0, env_add=env_add@entry=0x0, verbose=verbose@entry=false, closure=closure@entry=0x7fffffffe1d0) at ./sudoers.c:401</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2  0x00007ffff79de5f2 in sudoers_policy_check (argc=3, argv=0x555555584590, env_add=0x0, command_infop=0x7fffffffe290, argv_out=0x7fffffffe298, user_env_out=0x7fffffffe2a0, errstr=0x7fffffffe2b8) at ./policy.c:1028</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#3  0x000055555555aefa in policy_check (user_env_out=0x7fffffffe2a0, argv_out=0x7fffffffe298, command_info=0x7fffffffe290, env_add=0x0, argv=0x555555584590, argc=3) at ./sudo.c:1171</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#4  main (argc=argc@entry=3, argv=argv@entry=0x7fffffffe538, envp=&lt;optimized out&gt;) at ./sudo.c:269</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#5  0x00007ffff7da4083 in __libc_start_main (main=0x55555555aa00 &lt;main&gt;, argc=3, argv=0x7fffffffe538, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7fffffffe528) at ../csu/libc-start.c:308</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#6  0x000055555555d06e in _start ()</span>
</span></span></code></pre></div><p>set_cmnd 就是漏洞触发点所在的函数了，其中有如下逻辑：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * Fill in user_cmnd, user_args, user_base and user_stat variables
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> * and apply any command-specific defaults entries.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span>
</span></span><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">set_cmnd</span>(<span style="color:#458;font-weight:bold">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>		<span style="color:#998;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>  	<span style="color:#998;font-style:italic">// 取消转义符需满足的条件1
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (sudo_mode <span style="color:#000;font-weight:bold">&amp;</span> (MODE_RUN <span style="color:#000;font-weight:bold">|</span> MODE_EDIT <span style="color:#000;font-weight:bold">|</span> MODE_CHECK)) {
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#998;font-style:italic">/* set user_args */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> (NewArgc <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>to, <span style="color:#000;font-weight:bold">*</span>from, <span style="color:#000;font-weight:bold">**</span>av;
</span></span><span style="display:flex;"><span>            size_t size, n;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">/* Alloc and build up user_args. */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">for</span> (size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, av <span style="color:#000;font-weight:bold">=</span> NewArgv <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>; <span style="color:#000;font-weight:bold">*</span>av; av<span style="color:#000;font-weight:bold">++</span>)
</span></span><span style="display:flex;"><span>                size <span style="color:#000;font-weight:bold">+=</span> strlen(<span style="color:#000;font-weight:bold">*</span>av) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">if</span> (size <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> (user_args <span style="color:#000;font-weight:bold">=</span> malloc(size)) <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) {
</span></span><span style="display:flex;"><span>                sudo_warnx(U_(<span style="color:#d14">&#34;%s: %s&#34;</span>), __func__, U_(<span style="color:#d14">&#34;unable to allocate memory&#34;</span>));
</span></span><span style="display:flex;"><span>                debug_return_int(NOT_FOUND_ERROR);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>          	<span style="color:#998;font-style:italic">// 取消转义符需满足的条件2
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">if</span> (ISSET(sudo_mode, MODE_SHELL<span style="color:#000;font-weight:bold">|</span>MODE_LOGIN_SHELL)) {
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                 * When running a command via a shell, the sudo front-end
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                 * escapes potential meta chars.  We unescape non-spaces
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                 * for sudoers matching and logging purposes.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">                 */</span>
</span></span><span style="display:flex;"><span>              	<span style="color:#998;font-style:italic">// 遍历传入的参数
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                <span style="color:#000;font-weight:bold">for</span> (to <span style="color:#000;font-weight:bold">=</span> user_args, av <span style="color:#000;font-weight:bold">=</span> NewArgv <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>; (from <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>av); av<span style="color:#000;font-weight:bold">++</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">while</span> (<span style="color:#000;font-weight:bold">*</span>from) {
</span></span><span style="display:flex;"><span>                        <span style="color:#998;font-style:italic">// 当当前字符为 \，且其后紧跟的字符不为空格时，则跳过对当前字符 \ 的复制
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        <span style="color:#998;font-style:italic">// 即：将传入的命令参数字符串中的所有转义符舍去
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                        <span style="color:#000;font-weight:bold">if</span> (from[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;\\&#39;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>isspace((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span>)from[<span style="color:#099">1</span>]))
</span></span><span style="display:flex;"><span>                            from<span style="color:#000;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>                        <span style="color:#000;font-weight:bold">*</span>to<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>from<span style="color:#000;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">*</span>to<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39; &#39;</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">*--</span>to <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            } <span style="color:#000;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>            		<span style="color:#998;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            }
</span></span><span style="display:flex;"><span>      	}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">//...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><p>回到文章开头的例子，我们可以分析其中的错误原因了：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>➜  sudo git:<span style="color:#000;font-weight:bold">(</span>master<span style="color:#000;font-weight:bold">)</span> ✗ <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span><span style="display:flex;"><span>malloc<span style="color:#000;font-weight:bold">()</span>: corrupted top size
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>    <span style="color:#099">1357050</span> abort <span style="color:#000;font-weight:bold">(</span>core dumped<span style="color:#000;font-weight:bold">)</span>  <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span></code></pre></div><p>对于这段代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">while</span> (<span style="color:#000;font-weight:bold">*</span>from) {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 当当前字符为 \，且其后紧跟的字符不为空格时，则跳过对当前字符 \ 的复制
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 即：将传入的命令参数字符串中的所有转义符舍去
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (from[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#39;\\&#39;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>isspace((<span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span>)from[<span style="color:#099">1</span>]))
</span></span><span style="display:flex;"><span>    		from<span style="color:#000;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">*</span>to<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>from<span style="color:#000;font-weight:bold">++</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>若传入的命令参数字符串以 \ 结尾，则会使得处理该 \ 字符时出现：</p>
<ul>
<li><code>from[0] == '\\'</code>（单走一个 \ )</li>
<li><code>from[1] == '\x00' </code>（C语言字符串结尾标记字符）</li>
</ul>
<p>导致此次循环中if条件成立，执行 from++，再加上下一行的 *to++ = *from++，使得from指针直接越过了原字符串的范围。由此导致<code>*from == \x00</code>时的一字节被略过，while继续执行，拷贝了额外的非法数据。</p>
<p>由此得到了程序中的错误，但这个错误是如何成为漏洞的，还需向上回溯被写入的缓冲区：</p>
<ul>
<li>向to指针指向的位置写入来自from指针的数据：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">*</span>to<span style="color:#000;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>from<span style="color:#000;font-weight:bold">++</span>;
</span></span></code></pre></div><ul>
<li>to指针用于向user_args缓冲区写入数据：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> (to <span style="color:#000;font-weight:bold">=</span> user_args, av <span style="color:#000;font-weight:bold">=</span> NewArgv <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>; (from <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>av); av<span style="color:#000;font-weight:bold">++</span>) {
</span></span></code></pre></div><ul>
<li>user_args缓冲区是malloc了size大小得到的堆缓冲区：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> (size <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">||</span> (user_args <span style="color:#000;font-weight:bold">=</span> malloc(size)) <span style="color:#000;font-weight:bold">==</span> <span style="color:#0086b3">NULL</span>) {
</span></span></code></pre></div><ul>
<li>堆缓冲区大小size由计算存储命令参数字符串所需的总字节数得到：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#998;font-style:italic">/* Alloc and build up user_args. */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">for</span> (size <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>, av <span style="color:#000;font-weight:bold">=</span> NewArgv <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>; <span style="color:#000;font-weight:bold">*</span>av; av<span style="color:#000;font-weight:bold">++</span>)
</span></span><span style="display:flex;"><span>		size <span style="color:#000;font-weight:bold">+=</span> strlen(<span style="color:#000;font-weight:bold">*</span>av) <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1</span>;
</span></span></code></pre></div><p>那么向user_args堆块中写入过量的数据，则造成堆溢出。</p>
<p>且慢！单看这里的代码的确有问题，但我们假设的以单一一个 \ 结尾的字符串真的能传递到这里来吗？</p>
<p>毕竟如果是两个 \ 结尾的字符串，则<code>*from == \x00</code>时则正确命中while判断，程序不会出错。</p>
<p>而前面parse_args函数做的处理，正是会将 \ 前面再添加上一个转义符 \ 的呀。</p>
<p>那这里为啥会成功触发错误？先揭晓下答案，再针对其进行分析：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>➜  sudo git:<span style="color:#000;font-weight:bold">(</span>master<span style="color:#000;font-weight:bold">)</span> ✗ <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span><span style="display:flex;"><span>malloc<span style="color:#000;font-weight:bold">()</span>: corrupted top size
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>1<span style="color:#000;font-weight:bold">]</span>    <span style="color:#099">1383588</span> abort <span style="color:#000;font-weight:bold">(</span>core dumped<span style="color:#000;font-weight:bold">)</span>  <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudoedit -s <span style="color:#d14">&#39;\&#39;</span>
</span></span><span style="display:flex;"><span>➜  sudo git:<span style="color:#000;font-weight:bold">(</span>master<span style="color:#000;font-weight:bold">)</span> ✗ <span style="color:#008080">LD_LIBRARY_PATH</span><span style="color:#000;font-weight:bold">=</span>./lib/util/.libs/ src/.libs/sudo -s <span style="color:#d14">&#39;\&#39;</span>
</span></span><span style="display:flex;"><span>zsh:1: <span style="color:#0086b3">command</span> not found: <span style="color:#d14">\
</span></span></span></code></pre></div><p>文章前半部分为sudo建立了一个符号链接sudoedit，可以看到此时使用sudoedit执行就能成功触发漏洞，但使用原本的sudo则不可以。所以代码中肯定有逻辑对于启动时不同的程序名称做出了判断，进而执行了不同逻辑。</p>
<p>回到源代码中，我们观察到parse_args函数添加转义符的触发条件和set_cmnd函数取消转义符的触发条件是不同的：</p>
<ul>
<li>parse_args</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> (ISSET(mode, MODE_RUN) <span style="color:#000;font-weight:bold">&amp;&amp;</span> ISSET(flags, MODE_SHELL)) {
</span></span></code></pre></div><ul>
<li>set_cmnd</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> (sudo_mode <span style="color:#000;font-weight:bold">&amp;</span> (MODE_RUN <span style="color:#000;font-weight:bold">|</span> MODE_EDIT <span style="color:#000;font-weight:bold">|</span> MODE_CHECK)) {
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">if</span> (ISSET(sudo_mode, MODE_SHELL<span style="color:#000;font-weight:bold">|</span>MODE_LOGIN_SHELL)) {
</span></span></code></pre></div><p>即：</p>
<ul>
<li>添加转义符操作需满足mode设置了MODE_RUN，且flags设置了MODE_SHELL</li>
<li>取消转义符操作需sudo_mode设置了(MODE_RUN|MODE_EDIT|MODE_CHECK) &amp;&amp; (MODE_SHELL|MODE_LOGIN_SHELL)</li>
</ul>
<p>那么想要达成<strong>不执行添加转义符的操作，且执行取消转义符的操作</strong>的目的，就需要满足：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>MODE_SHELL <span style="color:#000;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span>MODE_RUN <span style="color:#000;font-weight:bold">&amp;&amp;</span> (MODE_EDIT <span style="color:#000;font-weight:bold">||</span> MODE_CHECK)
</span></span></code></pre></div><p>看来需要寻找MODE_EDIT与MODE_CHECK从何而来了。</p>
<p>从parse_args中可知，它们来自于-e和-l参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">parse_args</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">**</span>argv, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>old_optind, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>nargc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>nargv,
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">struct</span> sudo_settings <span style="color:#000;font-weight:bold">**</span>settingsp, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>env_addp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">for</span> (;;)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">if</span> ((ch <span style="color:#000;font-weight:bold">=</span> getopt_long(argc, argv, short_opts, long_opts, <span style="color:#0086b3">NULL</span>)) <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">-</span><span style="color:#099">1</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">switch</span> (ch)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#39;e&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span> (mode <span style="color:#000;font-weight:bold">&amp;&amp;</span> mode <span style="color:#000;font-weight:bold">!=</span> MODE_EDIT)
</span></span><span style="display:flex;"><span>                    usage_excl();
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">// 设置 mode 为 MODE_EDIT
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                mode <span style="color:#000;font-weight:bold">=</span> MODE_EDIT;
</span></span><span style="display:flex;"><span>                sudo_settings[ARG_SUDOEDIT].value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;true&#34;</span>;
</span></span><span style="display:flex;"><span>                valid_flags <span style="color:#000;font-weight:bold">=</span> MODE_NONINTERACTIVE;
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">case</span> <span style="color:#d14">&#39;l&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">if</span> (mode)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">if</span> (mode <span style="color:#000;font-weight:bold">==</span> MODE_LIST)
</span></span><span style="display:flex;"><span>                        SET(flags, MODE_LONG_LIST);
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>                        usage_excl();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#998;font-style:italic">// 设置 mode 为 MODE_LIST
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>                mode <span style="color:#000;font-weight:bold">=</span> MODE_LIST;
</span></span><span style="display:flex;"><span>                valid_flags <span style="color:#000;font-weight:bold">=</span> MODE_NONINTERACTIVE <span style="color:#000;font-weight:bold">|</span> MODE_LONG_LIST;
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 在此处将 MODE_LIST 更新为 MODE_CHECK
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> (argc <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> mode <span style="color:#000;font-weight:bold">==</span> MODE_LIST)
</span></span><span style="display:flex;"><span>        mode <span style="color:#000;font-weight:bold">=</span> MODE_CHECK;
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#998;font-style:italic">// 必须绕过的特殊判断条件
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">if</span> ((flags <span style="color:#000;font-weight:bold">&amp;</span> valid_flags) <span style="color:#000;font-weight:bold">!=</span> flags)
</span></span><span style="display:flex;"><span>        usage();
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>}
</span></span></code></pre></div><p>它们的作用：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">-</span>e, <span style="color:#000;font-weight:bold">--</span>edit                    edit files instead of running a command
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">-</span>l, <span style="color:#000;font-weight:bold">--</span>list                    list user<span style="color:#a61717;background-color:#e3d2d2">&#39;</span>s privileges or check a specific command; use twice <span style="color:#000;font-weight:bold">for</span> longer format
</span></span></code></pre></div><p>由此看来，发现不妙：</p>
<ul>
<li>从功能描述上，-e、-l参数的功能和-s、-i参数的功能是冲突的，估计没法一起用</li>
<li>从源代码上看来，的确如此。通过-e、-l参数设定valid_flags变量，并进行如下判断的手法，sudo规避了上述用法，并向用户打印了usage教你怎么用它：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">if</span> ((flags <span style="color:#000;font-weight:bold">&amp;</span> valid_flags) <span style="color:#000;font-weight:bold">!=</span> flags)
</span></span><span style="display:flex;"><span>    usage();
</span></span></code></pre></div><p>绕过的方法呢？上文已经揭晓过了。使用sudoedit作为程序名调用sudo，能起到和sudo -e一样的效果，却不会进入parse_args中的这段判断逻辑中：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#458;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#900;font-weight:bold">parse_args</span>(<span style="color:#458;font-weight:bold">int</span> argc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">**</span>argv, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>old_optind, <span style="color:#458;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">*</span>nargc, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>nargv,
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">struct</span> sudo_settings <span style="color:#000;font-weight:bold">**</span>settingsp, <span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">***</span>env_addp)
</span></span><span style="display:flex;"><span>{   
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">/* First, check to see if we were invoked as &#34;sudoedit&#34;. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// 如果以 sudoedit 作为程序名
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    proglen <span style="color:#000;font-weight:bold">=</span> strlen(progname);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span> (proglen <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">4</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span> strcmp(progname <span style="color:#000;font-weight:bold">+</span> proglen <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">4</span>, <span style="color:#d14">&#34;edit&#34;</span>) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        progname <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;sudoedit&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// 则设置 mode 为 MODE_EDIT
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        mode <span style="color:#000;font-weight:bold">=</span> MODE_EDIT;
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">// 注意之后就没有再设置 valid_flags了
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        sudo_settings[ARG_SUDOEDIT].value <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;true&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>由此，到达漏洞点的路径就通畅了。</p>
</div>
  
</article>
<button class="floating-button">
    <a class="floating-button__link" href="https://cerr.cc/">
        <span style="font-size: large; font-family: monospace; font-weight: bolder;">~</span>
    </a>
</button>


    </div>
    
    <footer class="post-footer">
    <div class="footer">
        
            <div>© 2022, Zikey Vi</div>
        
        <div class="footer__socials">


<a
  href="mailto:dev2ero@foxmail.com"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Gmail</title><path d="M24 5.457v13.909c0 .904-.732 1.636-1.636 1.636h-3.819V11.73L12 16.64l-6.545-4.91v9.273H1.636A1.636 1.636 0 0 1 0 19.366V5.457c0-2.023 2.309-3.178 3.927-1.964L5.455 4.64 12 9.548l6.545-4.91 1.528-1.145C21.69 2.28 24 3.434 24 5.457z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://github.com/dev2ero"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://twitter.com/dev2ero"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
</a>&nbsp;&nbsp;



<a
  href="https://space.bilibili.com/210892014"
  target="_blank"
  class="social-link"
  rel="noopener"
>
  <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Bilibili</title><path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/></svg>
</a>

</div>
    </div>
</footer>


    
    
      
<script src="https://cerr.cc/js/script.js"></script>

    
  </body>
</html>
