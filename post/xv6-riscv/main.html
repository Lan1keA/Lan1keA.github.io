<header>
    <title>XV6-RISCV</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/lib/page.css">
    <style> html * { color: #f2f2f2 !important; font-family: Terminus !important; } </style>
</header>

<body>
    <h1>main!树干在此</h1>
<pre>
main函数位于/kernel/main.c，实现如下：

    // start() jumps here in supervisor mode on all CPUs.
    void
    main()
    {
        if(cpuid() == 0){           // CPU0的工作：一系列基础初始化
            consoleinit();
            printfinit();
            printf("\n");
            printf("xv6 kernel is booting\n");
            printf("\n");
            kinit();         // physical page allocator
            kvminit();       // create kernel page table
            kvminithart();   // turn on paging
            procinit();      // process table
            trapinit();      // trap vectors
            trapinithart();  // install kernel trap vector
            plicinit();      // set up interrupt controller
            plicinithart();  // ask PLIC for device interrupts
            binit();         // buffer cache
            iinit();         // inode table
            fileinit();      // file table
            virtio_disk_init(); // emulated hard disk
            userinit();      // first user process
            __sync_synchronize();
            started = 1;
        } else {                    // 其余CPU核心的工作：多核心相关的初始化
            while(started == 0)     // 要等CPU0的活先干完，原地死循环等待
            ;
            __sync_synchronize();
            printf("hart %d starting\n", cpuid());
            kvminithart();    // turn on paging
            trapinithart();   // install kernel trap vector
            plicinithart();   // ask PLIC for device interrupts
        }

        scheduler();        
    }

XV6的树干便是这里，进一步的解析需要结合枝叶。

除此之外还有一个全局变量：

    volatile static int started = 0;    // CPU0的基础初始化完成了吗？初始化为"没有哦"

注：在C语言中，volatile关键字可以用来提醒编译器它后面所定义的变量随时有可能改变，因此编译后的程序每次需要存储或读取这个变量的时候，都会直接从变量地址中读取数据。
    如果没有volatile关键字，则编译器可能优化读取和存储，可能暂时使用寄存器中的值，如果这个变量由别的程序更新了的话，将出现不一致的现象。

</pre>

</body>