<header>
    <title>XV6-RISCV</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/lib/page.css">
    <style> html * { color: #f2f2f2 !important; font-family: Terminus !important; } </style>
</header>

<body>
    <h1>用户态的工作</h1>
<pre>
到了这里，内核已经完成了所有初始化的工作，此时便可以开始执行文件系统中的用户态代码了。就像Linux的init程序一样，XV6也有着相应的初始化程序init。
用户态的第一行代码位于/user/initcode.S中：

    # Initial process that execs /init.
    # This code runs in user space.

    #include "syscall.h"

    # exec(init, argv)
    .globl start
    start:
            la a0, init
            la a1, argv
            li a7, SYS_exec
            ecall

    # for(;;) exit();
    exit:
            li a7, SYS_exit
            ecall
            jal exit

    # char init[] = "/init\0";
    init:
    .string "/init\0"

    # char *argv[] = { init, 0 };
    .p2align 2
    argv:
    .long init
    .long 0

可以看到程序入口.start进行的工作是完成exec("/init\0", init, 0)系统调用，以此跳转到init程序的代码中。init程序的源码位于/user/init.c中：

    // init: The initial user-level program

    #include "kernel/types.h"
    #include "kernel/stat.h"
    #include "kernel/spinlock.h"
    #include "kernel/sleeplock.h"
    #include "kernel/fs.h"
    #include "kernel/file.h"
    #include "user/user.h"
    #include "kernel/fcntl.h"

    char *argv[] = { "sh", 0 };

    int
    main(void)
    {
    int pid, wpid;

    if(open("console", O_RDWR) < 0){
        mknod("console", CONSOLE, 0);
        open("console", O_RDWR);
    }
    dup(0);  // stdout
    dup(0);  // stderr

    for(;;){
        printf("init: starting sh\n");
        pid = fork();
        if(pid < 0){
        printf("init: fork failed\n");
        exit(1);
        }
        if(pid == 0){
        exec("sh", argv);
        printf("init: exec sh failed\n");
        exit(1);
        }

        for(;;){
        // this call to wait() returns if the shell exits,
        // or if a parentless process exits.
        wpid = wait((int *) 0);
        if(wpid == pid){
            // the shell exited; restart it.
            break;
        } else if(wpid < 0){
            printf("init: wait returned an error\n");
            exit(1);
        } else {
            // it was a parentless process; do nothing.
        }
        }
    }
    }

咕咕
</pre>

</body>